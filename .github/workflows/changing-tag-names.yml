name: Trigger Build (staging) and Deploy (staging) Backend Services

on:
  push:
    tags:
      - '*' 

jobs:
  trigger-deployment:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Extract tag info
        run: |
          TAG_FULL=${GITHUB_REF#refs/tags/}
          PREFIX=$(echo "$TAG_FULL" | cut -d'/' -f1)
          TAG_NAME=$(echo "$TAG_FULL" | cut -d'/' -f2)
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV

      - name: Print client payload
        run: |
          echo 'Dispatching with payload:'
          echo "Prefix: ${{ env.PREFIX }}"
          echo "Tag: ${{ env.TAG_NAME }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

      - name: Dispatch repository event based on prefix
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TAGRELEASE }}
          repository: Prashanth-Fdo5/delete-action-test
          event-type: build-and-deploy-staging
          client-payload: >-
            {
              "tag": "${{ env.TAG_NAME }}",
              "ref": "${{ github.ref }}",
              "commit": "${{ github.sha }}"
            }
