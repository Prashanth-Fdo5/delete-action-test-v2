name: Trigger HRM/CRM Build and Deploy (Staging)

on:
  push:
    tags:
      - 'hrm/v*'
      - 'crm/v*'  

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Extract tag components
        run: |
          TAG_FULL=${GITHUB_REF#refs/tags/}
          PREFIX=$(echo "$TAG_FULL" | cut -d'/' -f1)
          TAG_NAME=$(echo "$TAG_FULL" | cut -d'/' -f2)

          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Validate prefix (must be hrm or crm)
        if: ${{ env.PREFIX != 'hrm' && env.PREFIX != 'crm' }}
        run: |
          echo "❌ Unsupported tag prefix: '${{ env.PREFIX }}'"
          exit 1

      - name: Print dispatch details
        run: |
          echo "✅ Dispatching:"
          echo "Prefix: ${{ env.PREFIX }}"
          echo "Tag:    ${{ env.TAG_NAME }}"
          echo "Ref:    ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

      - name: Dispatch to deployment repository
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.SECRETS_TAG_TRIGGER }}
          repository: Prashanth-Fdo5/delete-action-test
          event-type: build-and-deploy-staging-${{ env.PREFIX }}
          client-payload: >-
            {
              "tag": "${{ env.TAG_NAME }}",
              "ref": "${{ github.ref }}",
              "commit": "${{ github.sha }}"
            }
