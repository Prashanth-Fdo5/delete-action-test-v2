name: Delete Old Git Tags

on:
  workflow_dispatch:
    inputs:
      keep:
        description: 'Number of latest tags to keep'
        required: true
        default: '10'

jobs:
  delete-old-tags:
    runs-on: ubuntu-latest

    permissions:
      contents: write  

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch all tags
        run: git fetch --tags

      - name: Delete old tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          KEEP_TAGS: ${{ github.event.inputs.keep }}
        run: |
          echo "Listing all tags..."
          TAGS=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags)
          
          echo "Keeping the latest $KEEP_TAGS tags..."
          COUNT=0

          for TAG in $TAGS; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -le $KEEP_TAGS ]; then
              echo "Keeping tag: $TAG"
              continue
            fi

            echo "Deleting tag: $TAG"

            # Make the DELETE API call
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              -H "Authorization: token $GITHUB_TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$TAG)

            if [[ "$RESPONSE" == "204" ]]; then
              echo "✅ Successfully deleted tag $TAG"
            else
              echo "❌ Failed to delete tag $TAG (HTTP $RESPONSE)"
            fi
          done
