name: Auto Delete Old Git Tags on New Tag Push

on:
  push:
    tags:
      - '*' 

jobs:
  delete-old-tags:
    runs-on: ubuntu-latest

    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean local tags and fetch remote
        run: |
          git tag -l | xargs -r git tag -d || true
          git fetch --tags --force

      - name: Delete old tags (keep only latest 10)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEEP_TAGS=10

          echo "Listing all remote tags..."
          TAGS=$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags)

          COUNT=0
          for TAG in $TAGS; do
            COUNT=$((COUNT + 1))
            if [ $COUNT -le $KEEP_TAGS ]; then
              echo "‚úÖ Keeping tag: $TAG"
              continue
            fi

            echo "üóë Deleting old tag: $TAG"

            # Call GitHub API to delete the tag
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
              -H "Authorization: token $GITHUB_TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$TAG)

            if [[ "$RESPONSE" == "204" ]]; then
              echo "‚úÖ Successfully deleted tag $TAG"
            else
              echo "‚ùå Failed to delete tag $TAG (HTTP $RESPONSE)"
            fi
          done

