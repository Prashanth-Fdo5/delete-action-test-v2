name: Notify Zoho Cliq on Tag or Production Deployment

on:
  push:
    tags:
      - '*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  notify-and-deploy:
    runs-on: ubuntu-latest
    continue-on-error: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract common environment info
        run: |
          echo "TAG_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "DEPLOYED_BY=${{ github.actor }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "WORKFLOW_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

      - name: Notify Staging Tag Push
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969

        run: |
          cat <<EOF > payload.json
          {
            "text": "üöÄ Staging Release Notification",
            "bot": {
              "name": "Release Bot",
              "image": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
            },
            "card": {
              "title": "New Tag Release",
              "theme": "modern-inline"
            },
            "slides": [
              {
                "type": "label",
                "title": "Release Details",
                "data": [
                  { "Tag": "${TAG_NAME}" },
                  { "Author": "${DEPLOYED_BY}" },
                  { "Repository": "${GITHUB_REPOSITORY}" },
                  { "View on GitHub": "[üîó View Tag](https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME})" }
                ]
              }
            ]
          }
          EOF
          curl -X POST "$CLIQ_WEBHOOK_URL" -H "Content-Type: application/json" -d @payload.json
          rm payload.json

      - name: Notify Production Deployment
        if: github.event_name == 'release' && github.event.action == 'published'
        env:
         CLIQ_WEBHOOK_URL: 
        run: |
          cat <<EOF > payload.json
          {
            "text": "üéâ Production Deployment Triggered!",
            "bot": {
              "name": "Production Deploy Bot",
              "image": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
            },
            "card": {
              "title": "New Production Deployment Release",
              "theme": "modern-inline"
            },
            "slides": [
              {
                "type": "label",
                "title": "Deployment Details",
                "data": [
                  { "Environment": "üî¥ Production" },
                  { "Release": "${{ github.event.release.tag_name }}" },
                  { "Release Name": "${{ github.event.release.name }}" },
                  { "Published By": "${{ github.event.release.author.login }}" },
                  { "Repository": "${GITHUB_REPOSITORY}" },
                  { "Deployment Time": "${DEPLOYMENT_TIME}" },
                  { "View Release": "[üîó View Release](${{ github.event.release.html_url }})" }
                ]
              }
            ]
          }
          EOF
          curl -X POST "$CLIQ_WEBHOOK_URL" -H "Content-Type: application/json" -d @payload.json
          rm payload.json

      - name: Example Deploy Step
        run: |
            echo "job status is: ${{ job.status }}"

          
      - name: Notify Final Deployment Status
        if: always()
        env:
         CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969
         
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="‚úÖ Deployment completed successfully"
          else
            STATUS="‚ùå Deployment failed"
          fi
          cat <<EOF > payload.json
          {
            "text": "$STATUS",
            "bot": {
              "name": "Deployment Status Bot",
              "image": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
            }
          }
          EOF
          curl -X POST "$CLIQ_WEBHOOK_URL" -H "Content-Type: application/json" -d @payload.json
          rm payload.json
