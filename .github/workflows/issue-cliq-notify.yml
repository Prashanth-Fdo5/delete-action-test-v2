name: Notify Zoho Cliq on Issue Creation

on:
  issues:
    types: [opened]

jobs:
  notify-cliq:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue details to Zoho Cliq
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969
        run: |
          echo "Collecting issue details..."

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_CREATOR="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"

          # Get assignees as comma-separated string
          ISSUE_ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r '.[].login' | paste -sd "," -)
          [ -z "$ISSUE_ASSIGNEES" ] && ISSUE_ASSIGNEES="None"

          # Get labels as comma-separated string
          ISSUE_LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name' | paste -sd "," -)
          [ -z "$ISSUE_LABELS" ] && ISSUE_LABELS="None"

          # Build JSON safely using jq (no broken quotes!)
          PAYLOAD=$(jq -n \
            --arg text "*New GitHub Issue Created*\n**Title:** $ISSUE_TITLE\n**Creator:** $ISSUE_CREATOR\n**Assignees:** $ISSUE_ASSIGNEES\n**Type:** $ISSUE_LABELS\n**Link:** $ISSUE_URL" \
            '{text: $text}')

          echo "Sending payload:"
          echo "$PAYLOAD"

          curl -X POST "$CLIQ_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
