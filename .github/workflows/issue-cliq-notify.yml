name: Notify Zoho Cliq on Issue Creation

on:
  issues:
    types: [opened]

jobs:
  notify-cliq:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue details to Zoho Cliq
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969
        run: |
          echo "Extracting GitHub issue data..."

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_CREATOR="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"

          # Extract assignees
          ISSUE_ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r '.[]?.login' | paste -sd "," -)
          if [ -z "$ISSUE_ASSIGNEES" ]; then
            ISSUE_ASSIGNEES="None"
          fi

          # Extract labels (as issue type)
          ISSUE_LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[]?.name' | paste -sd "," -)
          if [ -z "$ISSUE_LABELS" ]; then
            ISSUE_LABELS="None"
          fi

          # Format message for Cliq (basic text format)
          MESSAGE="*New GitHub Issue Created*\n"\

          "**Title:** ${ISSUE_TITLE}\n"\
          "**Creator:** ${ISSUE_CREATOR}\n"\
          "**Assignees:** ${ISSUE_ASSIGNEES}\n"\
          "**Type:** ${ISSUE_LABELS}\n"\
          "**Link:** ${ISSUE_URL}"

          echo "Sending to Cliq..."
          curl -X POST "$CLIQ_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{\"text\": \"$MESSAGE\"}"
