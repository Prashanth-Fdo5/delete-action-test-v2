name: Notify Zoho Cliq on Issue Creation

on:
  issues:
    types: [opened]

jobs:
  notify-cliq:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue details to Zoho Cliq
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969
        run: |
          echo "Collecting issue details..."

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_CREATOR="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"

          # Get assignees as comma-separated list
          ISSUE_ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r '.[].login' | paste -sd "," -)
          if [ -z "$ISSUE_ASSIGNEES" ]; then
            ISSUE_ASSIGNEES="None"
          fi

          # Get labels as comma-separated list
          ISSUE_LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name' | paste -sd "," -)
          if [ -z "$ISSUE_LABELS" ]; then
            ISSUE_LABELS="None"
          fi

          # Format JSON message using printf
          PAYLOAD=$(printf '{"text": "*New GitHub Issue Created*\n**Title:** %s\n**Creator:** %s\n**Assignees:** %s\n**Type:** %s\n**Link:** %s"}' \
            "$ISSUE_TITLE" "$ISSUE_CREATOR" "$ISSUE_ASSIGNEES" "$ISSUE_LABELS" "$ISSUE_URL")

          echo "Sending message to Zoho Cliq..."
          curl -X POST "$CLIQ_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"


                      
