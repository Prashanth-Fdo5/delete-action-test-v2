name: Notify Zoho Cliq on Issue Creation

on:
  issues:
    types: [opened]

jobs:
  notify-cliq:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue as card to Zoho Cliq
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/testingchannel/message?zapikey=1001.2b828b4afe6ae4aa449846b35439e65f.cc8102b654e1beb905a79042add90969
        run: |
          echo "Collecting issue details..."

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_CREATOR="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"

          # Get assignees as comma-separated string
          ISSUE_ASSIGNEES=$(echo '${{ toJson(github.event.issue.assignees) }}' | jq -r '.[].login' | paste -sd "," -)
          [ -z "$ISSUE_ASSIGNEES" ] && ISSUE_ASSIGNEES="None"

          # Get labels as comma-separated string
          ISSUE_LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name' | paste -sd "," -)
          [ -z "$ISSUE_LABELS" ] && ISSUE_LABELS="None"

          echo "Building JSON payload for Cliq..."

          PAYLOAD=$(jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg creator "$ISSUE_CREATOR" \
            --arg assignees "$ISSUE_ASSIGNEES" \
            --arg labels "$ISSUE_LABELS" \
            --arg url "$ISSUE_URL" \
            '{
              text: "*New GitHub Issue Created*",
              bot: {
                name: "GitHub Notifier",
                image: "https://www.zoho.com/sites/zweb/images/cliq/restapi/zoho-cliq-bot-icon.png"
              },
              card: {
                theme: "modern-inline"
              },
              slides: [
                {
                  type: "list",
                  title: "GitHub Issue Details",
                  data: [
                    "üìù Title: \($title)",
                    "üë§ Creator: \($creator)",
                    "üë• Assignees: \($assignees)",
                    "üè∑Ô∏è Type: \($labels)",
                    "üîó [View Issue](\($url))"
                  ]
                }
              ]
            }')

          echo "Sending payload to Cliq..."
          curl -X POST "$CLIQ_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
